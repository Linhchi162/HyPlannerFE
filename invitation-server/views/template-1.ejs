<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Thiệp cưới online của <%= weddingData.groomName %> và <%= weddingData.brideName %>"
    />
    <title>
      Trang Cưới Của <%= weddingData.groomName %> & <%= weddingData.brideName %>
    </title>
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Montserrat:wght@300;400;500&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Base styles */
      * {
        box-sizing: border-box;
      }
      body {
        font-family: "Montserrat", sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f8f8f8;
        color: #333;
        line-height: 1.6;
      }
      header {
        background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)),
          url("<%= weddingData.album && weddingData.album.length > 0 ? weddingData.album[0] : 'https://images.pexels.com/photos/169198/pexels-photo-169198.jpeg' %>")
            no-repeat center center/cover;
        color: white;
        text-align: center;
        padding: 100px 20px;
        position: relative;
      }
      header h1 {
        font-family: "Playfair Display", serif;
        font-size: 3.5em;
        margin-bottom: 10px;
      }
      header h2 {
        font-family: "Playfair Display", serif;
        font-size: 2em;
        margin-top: 0;
      }
      header p {
        font-size: 1.2em;
      }
      .container {
        max-width: 960px;
        margin: 40px auto;
        padding: 0 20px;
      }
      section {
        background-color: white;
        padding: 40px;
        margin-bottom: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }
      section h3 {
        font-family: "Playfair Display", serif;
        font-size: 2.5em;
        color: #a0522d;
        text-align: center;
        margin-bottom: 40px;
        position: relative;
      }
      section h3::after {
        content: "";
        position: absolute;
        left: 50%;
        bottom: -15px;
        transform: translateX(-50%);
        width: 60px;
        height: 3px;
        background-color: #a0522d;
      }
      .couple-names {
        font-family: "Playfair Display", serif;
        font-size: 1.8em;
        margin-top: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 15px;
      }
      .couple-names span {
        color: #fff;
        text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7);
      }
      .couple-names .and {
        font-size: 0.8em;
        color: white;
      }
      .video-container {
        position: relative;
        padding-bottom: 56.25%;
        height: 0;
        overflow: hidden;
        margin-top: 30px;
        border-radius: 8px;
      }
      .video-container iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border: 0;
      }
      .love-story-item {
        display: flex;
        align-items: center;
        margin-bottom: 40px;
        gap: 30px;
      }
      .love-story-item:nth-child(even) {
        flex-direction: row-reverse;
      }
      .love-story-item img {
        width: 40%;
        max-width: 300px;
        height: auto;
        border-radius: 8px;
        object-fit: cover;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }
      .love-story-content {
        flex: 1;
        padding: 20px;
        background-color: #fdfaf7;
        border-radius: 8px;
      }
      .love-story-content h4 {
        font-family: "Playfair Display", serif;
        color: #a0522d;
        font-size: 1.8em;
        margin-bottom: 5px;
      }
      .love-story-content p.time {
        font-style: italic;
        color: #666;
        margin-top: 0;
        margin-bottom: 15px;
      }
      .love-story-content p.content {
        font-size: 1em;
        color: #555;
      }
      .album-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
      }
      .album-grid img {
        width: 100%;
        height: 200px;
        object-fit: cover;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        transition: transform 0.2s ease-in-out;
        background-color: #f0f0f0;
      }
      .album-grid img:hover {
        transform: scale(1.03);
      }
      .event-item {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
        align-items: flex-start;
        background-color: #fdfaf7;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }
      .event-item img {
        width: 150px;
        height: 150px;
        object-fit: cover;
        border-radius: 8px;
        flex-shrink: 0;
      }
      .event-details h4 {
        font-family: "Playfair Display", serif;
        color: #a0522d;
        font-size: 1.5em;
        margin-top: 0;
        margin-bottom: 5px;
      }
      .event-details p {
        margin: 5px 0;
        color: #555;
      }
      .event-details a {
        color: #a0522d;
        text-decoration: none;
        font-weight: 500;
      }
      .event-details a:hover {
        text-decoration: underline;
      }
      .guestbook-messages {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
      }
      .guestbook-card {
        background-color: #fdfaf7;
        padding: 20px;
        border-left: 5px solid #a0522d;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        word-wrap: break-word;
      }
      .guestbook-card p.name {
        font-weight: bold;
        color: #a0522d;
        margin-bottom: 5px;
      }
      .guestbook-card p.message {
        font-style: italic;
        color: #666;
      }
      .form-group {
        margin-bottom: 20px;
      }
      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #444;
      }
      .form-group input,
      .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-family: "Montserrat", sans-serif;
        font-size: 1em;
        box-sizing: border-box;
        transition: border-color 0.3s;
      }
      .form-group input:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #a0522d;
        box-shadow: 0 0 5px rgba(160, 82, 45, 0.2);
      }
      .error-message {
        color: #dc3545;
        font-size: 0.875em;
        margin-top: 5px;
        display: none;
      }
      .submit-btn {
        display: block;
        width: 100%;
        padding: 15px;
        background-color: #a0522d;
        color: white;
        border: none;
        border-radius: 8px;
        font-family: "Montserrat", sans-serif;
        font-size: 1.1em;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      .submit-btn:hover:not(:disabled) {
        background-color: #8c462f;
      }
      .submit-btn:disabled {
        background-color: #c8a18a;
        cursor: not-allowed;
      }
      .event-button {
        display: inline-block;
        padding: 8px 15px;
        background-color: #eee;
        color: #555;
        text-decoration: none;
        border-radius: 5px;
        font-size: 0.9em;
        font-weight: 500;
        transition: background-color 0.2s;
      }
      .event-button:hover {
        background-color: #ddd;
      }
      .directions-button {
        background-color: #a0522d;
        color: white;
      }
      .directions-button:hover {
        background-color: #8c462f;
      }
      .event-item-layout {
        display: flex;
        gap: 30px;
        align-items: flex-start;
      }
      .event-image-fixed {
        width: 150px;
        height: 150px;
        object-fit: cover;
        border-radius: 8px;
        flex-shrink: 0;
      }
      .event-details-column {
        flex: 1;
        min-width: 0;
      }
      .event-map-column {
        width: 40%;
        flex-shrink: 0;
      }
      /* Toast notification */
      .toast {
        position: fixed;
        bottom: 30px;
        right: 30px;
        background-color: #333;
        color: white;
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.3s ease;
        max-width: 400px;
      }
      .toast.show {
        opacity: 1;
        transform: translateY(0);
      }
      .toast.success {
        background-color: #28a745;
      }
      .toast.error {
        background-color: #dc3545;
      }
      /* Loading skeleton */
      .skeleton {
        background: linear-gradient(
          90deg,
          #f0f0f0 25%,
          #e0e0e0 50%,
          #f0f0f0 75%
        );
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
      }
      @keyframes loading {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }
      @media (max-width: 768px) {
        header {
          padding: 70px 20px;
        }
        header h1 {
          font-size: 2.5em;
        }
        header h2 {
          font-size: 1.5em;
        }
        .love-story-item,
        .love-story-item:nth-child(even) {
          flex-direction: column;
          text-align: center;
        }
        .love-story-item img {
          width: 80%;
          max-width: 400px;
        }
        .love-story-content {
          padding: 15px;
        }
        .event-item,
        .event-item-layout {
          flex-direction: column;
          align-items: center;
          text-align: center;
        }
        .event-item img,
        .event-image-fixed {
          margin-bottom: 15px;
        }
        .event-map-column {
          width: 100%;
          margin-top: 20px;
        }
        .event-details-column > div {
          justify-content: center;
        }
      }
      @media (max-width: 480px) {
        header h1 {
          font-size: 2em;
        }
        header h2 {
          font-size: 1.2em;
        }
        section {
          padding: 20px;
        }
        section h3 {
          font-size: 2em;
        }
      }
    </style>
  </head>
  <body>
    <header role="banner">
      <h1><%= weddingData.groomName %> & <%= weddingData.brideName %></h1>
      <div class="couple-names">
        <span><%= weddingData.groomName %></span>
        <span class="and">&</span>
        <span><%= weddingData.brideName %></span>
      </div>
      <p><%= weddingData.weddingDate %></p>
    </header>

    <main class="container">
      <section id="welcome">
        <h3>Chào mừng đến với ngày trọng đại của chúng tôi!</h3>
        <% if (weddingData.aboutCouple) { %>
        <p style="text-align: center; font-size: 1.1em; color: #555">
          <%= weddingData.aboutCouple %>
        </p>
        <% } else { %>
        <p style="text-align: center; font-size: 1.1em; color: #555">
          Chúng tôi rất vui mừng được chia sẻ khoảnh khắc đặc biệt này với tất
          cả mọi người. Cảm ơn bạn đã là một phần trong câu chuyện tình yêu của
          chúng tôi.
        </p>
        <% } %>
      </section>

      <% if (weddingData.youtubeUrl) { %>
      <section id="video">
        <h3>Video Kỷ Niệm</h3>
        <div class="video-container">
          <% let videoId = null; const url = weddingData.youtubeUrl; let match =
          url.match(/[?&]v=([^&]+)/); if (match) videoId = match[1]; if
          (!videoId) { match = url.match(/youtu\.be\/([^?]+)/); if (match)
          videoId = match[1]; } if (!videoId) { match =
          url.match(/youtube\.com\/embed\/([^?]+)/); if (match) videoId =
          match[1]; } if (!videoId) { match =
          url.match(/youtube\.com\/shorts\/([^?]+)/); if (match) videoId =
          match[1]; } %> <% if (videoId) { %>
          <iframe
            src="https://www.youtube.com/embed/<%= videoId %>"
            title="Video kỷ niệm cưới"
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen
            loading="lazy"
          >
          </iframe>
          <% } else { %>
          <p style="text-align: center; color: #dc3545">
            Link YouTube không hợp lệ.
          </p>
          <% } %>
        </div>
      </section>
      <% } %> <% if (weddingData.loveStory && weddingData.loveStory.length > 0)
      { %>
      <section id="love-story">
        <h3>Câu Chuyện Tình Yêu</h3>
        <% weddingData.loveStory.forEach(function(story) { %>
        <article class="love-story-item">
          <img
            src="<%= story.image %>"
            alt="<%= story.title %>"
            loading="lazy"
            onerror="this.style.display='none'"
          />
          <div class="love-story-content">
            <p class="time"><%= story.time %></p>
            <h4><%= story.title %></h4>
            <p class="content"><%= story.content %></p>
          </div>
        </article>
        <% }); %>
      </section>
      <% } %> <% if (weddingData.album && weddingData.album.length > 0) { %>
      <section id="album">
        <h3>Album Ảnh Cưới</h3>
        <div class="album-grid">
          <% weddingData.album.forEach(function(image) { %>
          <img
            src="<%= image %>"
            alt="Ảnh cưới"
            loading="lazy"
            onerror="this.style.display='none'"
          />
          <% }); %>
        </div>
      </section>
      <% } %> <% if (weddingData.events && weddingData.events.length > 0) { %>
      <section id="events">
        <h3>Chương Trình Cưới</h3>
        <% weddingData.events.forEach(function(event) { %>
        <article class="event-item event-item-layout">
          <% if (event.image) { %>
          <img
            src="<%= event.image %>"
            alt="<%= event.name %>"
            class="event-image-fixed"
            loading="lazy"
            onerror="this.style.display='none'"
          />
          <% } %>
          <div class="event-details-column">
            <h4><%= event.name %></h4>
            <p><strong>Thời gian:</strong> <%= event.time %></p>
            <p><strong>Địa điểm:</strong> <%= event.venue %></p>
            <p><strong>Địa chỉ:</strong> <%= event.address %></p>
            <div
              style="
                margin-top: 15px;
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
              "
            >
              <% if (event.mapLink && /^https?:\/\//.test(event.mapLink)) { %>
              <a
                href="<%= event.mapLink %>"
                target="_blank"
                rel="noopener noreferrer"
                class="event-button"
                >Xem bản đồ</a
              >
              <% } %>
            </div>
          </div>
          <% if (event.embedMapUrl) { %>
          <div class="event-map-column">
            <div
              class="map-container"
              style="
                position: relative;
                width: 100%;
                padding-bottom: 100%;
                height: 0;
                overflow: hidden;
                border-radius: 8px;
                border: 1px solid #eee;
              "
            >
              <iframe
                src="<%= event.embedMapUrl %>"
                width="100%"
                height="100%"
                style="position: absolute; top: 0; left: 0; border: 0"
                allowfullscreen=""
                loading="lazy"
                referrerpolicy="no-referrer-when-downgrade"
                title="Bản đồ địa điểm"
              >
              </iframe>
            </div>
          </div>
          <% } %>
        </article>
        <% }); %>
      </section>
      <% } %>

      <section id="rsvp" style="text-align: center">
        <h3>Bạn sẽ tham dự chứ?</h3>
        <p style="font-size: 1.1em; color: #555; margin-bottom: 30px">
          Sự hiện diện của bạn là niềm vinh hạnh lớn lao. Vui lòng xác nhận để
          chúng tôi có thể đón tiếp bạn thật chu đáo nhé!
        </p>
        <form id="rsvp-form" style="display: block" novalidate>
          <div class="form-group" style="text-align: left">
            <label for="rsvpName"
              >Tên của bạn <span style="color: #dc3545">*</span></label
            >
            <input
              type="text"
              id="rsvpName"
              name="name"
              placeholder="Nhập tên của bạn"
              required
              maxlength="100"
              aria-required="true"
              aria-describedby="rsvp-name-error"
            />
            <div id="rsvp-name-error" class="error-message" role="alert"></div>
          </div>
          <div class="form-group" style="text-align: left">
            <label for="rsvpEmail"
              >Email của bạn <span style="color: #dc3545">*</span></label
            >
            <input
              type="email"
              id="rsvpEmail"
              name="email"
              placeholder="Nhập email của bạn"
              required
              maxlength="100"
              aria-required="true"
              aria-describedby="rsvp-email-error"
            />
            <div id="rsvp-email-error" class="error-message" role="alert"></div>
          </div>
          <button
            type="submit"
            class="submit-btn"
            id="rsvp-btn"
            aria-label="Xác nhận tham dự tiệc cưới"
          >
            Xác nhận tham dự
          </button>
        </form>
        <p
          id="rsvp-thanks"
          style="
            display: none;
            font-size: 1.2em;
            color: #a0522d;
            font-weight: bold;
            margin-top: 20px;
          "
          role="status"
          aria-live="polite"
        >
          Cảm ơn bạn đã xác nhận! Hẹn gặp bạn tại buổi tiệc.
        </p>
      </section>

      <% if (weddingData.bankAccount && weddingData.bankAccount.bankBin &&
      weddingData.bankAccount.accountNumber) { %>
      <section id="wedding-gift">
        <h3>Mừng cưới</h3>
        <p
          style="
            text-align: center;
            font-size: 1.1em;
            color: #555;
            margin-bottom: 30px;
          "
        >
          Với những bạn bè ở xa không thể tham dự, bạn có thể gửi lời chúc mừng
          hạnh phúc cho cặp đôi qua mã QR dưới đây.
        </p>
        <div style="text-align: center">
          <img
            src="https://api.vietqr.io/image/<%= weddingData.bankAccount.bankBin %>-<%= weddingData.bankAccount.accountNumber %>-print.jpg?accountName=<%= encodeURIComponent(weddingData.groomName || '') %>&addInfo=<%= encodeURIComponent('Mung cuoi ' + (weddingData.groomName || '') + ' va ' + (weddingData.brideName || '')) %>"
            alt="Mã QR mừng cưới"
            style="
              width: 300px;
              height: auto;
              max-width: 100%;
              border-radius: 8px;
              box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            "
            loading="lazy"
            onerror="this.parentElement.innerHTML='<p style=color:#dc3545>Không thể tải mã QR</p>'"
          />
        </div>
      </section>
      <% } %>

      <section id="guestbook">
        <h3>Sổ Lưu Bút</h3>
        <div class="guestbook-messages" id="guestbook-messages-container">
          <% if (weddingData.guestbookMessages &&
          weddingData.guestbookMessages.length > 0) { %> <% function
          escapeHtml(text) { const map = { '&': '&amp;', '<': '&lt;', '>':
          '&gt;', '"': '&quot;', "'": '&#039;' }; return
          text.replace(/[&<>"']/g, m => map[m]); } %> <%
          weddingData.guestbookMessages .sort((a, b) => new
          Date(b.createdAt).getTime() - new Date(a.createdAt).getTime())
          .forEach(function(message) { %>
          <div class="guestbook-card">
            <p class="name"><%- escapeHtml(message.name) %></p>
            <p class="message">"<%- escapeHtml(message.message) %>"</p>
          </div>
          <% }); %> <% } else { %>
          <p
            id="no-messages-yet"
            style="text-align: center; color: #777; grid-column: 1 / -1"
          >
            Chưa có lời chúc nào. Hãy là người đầu tiên gửi lời chúc nhé!
          </p>
          <% } %>
        </div>
      </section>

      <div class="guestbook-form-container">
        <h4
          style="
            font-family: 'Playfair Display', serif;
            color: #a0522d;
            font-size: 1.8em;
            text-align: center;
            margin-bottom: 30px;
          "
        >
          Gửi Lời Chúc Của Bạn
        </h4>
        <form id="guestbook-form" novalidate>
          <div class="form-group">
            <label for="guestName"
              >Tên của bạn <span style="color: #dc3545">*</span></label
            >
            <input
              type="text"
              id="guestName"
              name="name"
              placeholder="Nhập tên của bạn"
              required
              maxlength="100"
              aria-required="true"
              aria-describedby="name-error"
            />
            <div id="name-error" class="error-message" role="alert"></div>
          </div>
          <div class="form-group">
            <label for="guestMessage"
              >Lời chúc <span style="color: #dc3545">*</span></label
            >
            <textarea
              id="guestMessage"
              name="message"
              rows="5"
              placeholder="Viết lời chúc của bạn tại đây..."
              required
              maxlength="500"
              aria-required="true"
              aria-describedby="message-error"
            ></textarea>
            <div id="message-error" class="error-message" role="alert"></div>
          </div>
          <button
            type="submit"
            class="submit-btn"
            id="submit-wish-btn"
            aria-label="Gửi lời chúc mừng cưới"
          >
            Gửi Lời Chúc
          </button>
        </form>
      </div>
    </main>

    <footer
      role="contentinfo"
      style="
        text-align: center;
        padding: 30px;
        background-color: #a0522d;
        color: white;
        margin-top: 50px;
      "
    >
      <p>
        Chúc mừng hạnh phúc của <%= weddingData.groomName %> và <%=
        weddingData.brideName %>
      </p>
      <p>© 2025. All Rights Reserved.</p>
    </footer>

    <!-- Toast notification -->
    <div
      id="toast"
      class="toast"
      role="alert"
      aria-live="assertive"
      aria-atomic="true"
    ></div>

    <script id="wedding-data" type="application/json">
      <%- JSON.stringify({ slug: weddingData.slug || "" }) %>
    </script>

    <script>
      // Utility functions
      function $(id) {
        return document.getElementById(id);
      }

      function showToast(message, type = "success") {
        const toast = $("toast");
        if (!toast) return;

        toast.textContent = message;
        toast.className = `toast ${type} show`;

        setTimeout(() => {
          toast.classList.remove("show");
        }, 4000);
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function validateInput(value, minLength, maxLength, fieldName) {
        if (!value || value.trim().length === 0) {
          return `${fieldName} không được để trống`;
        }
        if (value.trim().length < minLength) {
          return `${fieldName} phải có ít nhất ${minLength} ký tự`;
        }
        if (value.trim().length > maxLength) {
          return `${fieldName} không được vượt quá ${maxLength} ký tự`;
        }
        return null;
      }

      // Read wedding slug safely
      let weddingSlug = "";
      (function () {
        const el = $("wedding-data");
        if (!el) return;
        try {
          const parsed = JSON.parse(el.textContent || "{}");
          weddingSlug = parsed.slug || "";
        } catch (e) {
          console.error("Error parsing wedding data:", e);
        }
      })();

      // --- RSVP Logic ---
      const rsvpForm = $("rsvp-form");
      const rsvpButton = $("rsvp-btn");
      const rsvpThanks = $("rsvp-thanks");
      const rsvpNameInput = $("rsvpName");
      const rsvpEmailInput = $("rsvpEmail");
      const rsvpNameError = $("rsvp-name-error");
      const rsvpEmailError = $("rsvp-email-error");

      if (rsvpForm && rsvpButton && rsvpThanks) {
        const storageKey = `rsvp_confirmed_${weddingSlug}`;

        if (localStorage.getItem(storageKey) === "true") {
          rsvpForm.style.display = "none";
          rsvpThanks.style.display = "block";
        } else {
          rsvpForm.addEventListener("submit", async (event) => {
            event.preventDefault();

            // Clear previous errors
            if (rsvpNameError) {
              rsvpNameError.textContent = "";
              rsvpNameError.style.display = "none";
            }
            if (rsvpEmailError) {
              rsvpEmailError.textContent = "";
              rsvpEmailError.style.display = "none";
            }

            const name = rsvpNameInput.value.trim();
            const email = rsvpEmailInput.value.trim();

            // Validate name
            const nameValidation = validateInput(name, 2, 100, "Tên");
            if (nameValidation) {
              if (rsvpNameError) {
                rsvpNameError.textContent = nameValidation;
                rsvpNameError.style.display = "block";
              }
              rsvpNameInput.focus();
              return;
            }

            // Validate email
            if (!email || email.length === 0) {
              if (rsvpEmailError) {
                rsvpEmailError.textContent = "Email không được để trống";
                rsvpEmailError.style.display = "block";
              }
              rsvpEmailInput.focus();
              return;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
              if (rsvpEmailError) {
                rsvpEmailError.textContent = "Email không hợp lệ";
                rsvpEmailError.style.display = "block";
              }
              rsvpEmailInput.focus();
              return;
            }

            if (!weddingSlug) {
              showToast("Lỗi: Không tìm thấy thông tin sự kiện", "error");
              return;
            }

            rsvpButton.disabled = true;
            rsvpButton.innerText = "Đang gửi xác nhận...";

            try {
              const response = await fetch(
                `/inviletter/invitation/${weddingSlug}/rsvp`,
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({ name, email }),
                }
              );

              if (!response.ok) {
                let errorMsg = "Lỗi khi xác nhận. Vui lòng thử lại.";
                try {
                  const errorData = await response.json();
                  if (errorData && errorData.message) {
                    errorMsg = errorData.message;
                  }
                } catch (e) {
                  if (response.status === 404) {
                    errorMsg = "Không tìm thấy sự kiện";
                  } else if (response.status === 500) {
                    errorMsg = "Lỗi server. Vui lòng thử lại sau.";
                  }
                }
                throw new Error(errorMsg);
              }

              localStorage.setItem(storageKey, "true");
              rsvpForm.style.display = "none";
              rsvpThanks.style.display = "block";
              showToast("Xác nhận tham dự thành công! Cảm ơn bạn.", "success");
            } catch (error) {
              console.error("RSVP error:", error);
              const message =
                error instanceof Error ? error.message : String(error);
              showToast(message, "error");
              rsvpButton.disabled = false;
              rsvpButton.innerText = "Xác nhận tham dự";
            }
          });
        }
      }

      // --- Guestbook Logic ---
      const guestbookForm = $("guestbook-form");
      const guestNameInput = $("guestName");
      const guestMessageInput = $("guestMessage");
      const submitButton = $("submit-wish-btn");
      const messagesContainer = $("guestbook-messages-container");
      const nameError = $("name-error");
      const messageError = $("message-error");

      if (
        guestbookForm &&
        guestNameInput &&
        guestMessageInput &&
        submitButton &&
        messagesContainer
      ) {
        guestbookForm.addEventListener("submit", async (event) => {
          event.preventDefault();

          // Clear previous errors
          if (nameError) {
            nameError.textContent = "";
            nameError.style.display = "none";
          }
          if (messageError) {
            messageError.textContent = "";
            messageError.style.display = "none";
          }

          const name = guestNameInput.value.trim();
          const message = guestMessageInput.value.trim();

          // Validation
          const nameValidation = validateInput(name, 2, 100, "Tên");
          if (nameValidation) {
            if (nameError) {
              nameError.textContent = nameValidation;
              nameError.style.display = "block";
            }
            guestNameInput.focus();
            return;
          }

          const messageValidation = validateInput(message, 10, 500, "Lời chúc");
          if (messageValidation) {
            if (messageError) {
              messageError.textContent = messageValidation;
              messageError.style.display = "block";
            }
            guestMessageInput.focus();
            return;
          }

          if (!weddingSlug) {
            showToast("Lỗi: Không tìm thấy thông tin sự kiện", "error");
            return;
          }

          submitButton.disabled = true;
          submitButton.innerText = "Đang gửi...";

          try {
            const response = await fetch(
              `/inviletter/invitation/${weddingSlug}/add-wish`,
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ name, message }),
              }
            );

            const result = await response.json();

            if (!response.ok) {
              throw new Error(result.message || "Lỗi khi gửi lời chúc.");
            }

            showToast(
              "Gửi lời chúc thành công! Cảm ơn bạn rất nhiều.",
              "success"
            );

            // Remove "no messages" text
            const noMessagesEl = $("no-messages-yet");
            if (noMessagesEl) {
              noMessagesEl.remove();
            }

            // Add new message card safely
            const newMessageCard = document.createElement("div");
            newMessageCard.className = "guestbook-card";

            const nameP = document.createElement("p");
            nameP.className = "name";
            nameP.textContent = name;

            const messageP = document.createElement("p");
            messageP.className = "message";
            messageP.textContent = `"${message}"`;

            newMessageCard.appendChild(nameP);
            newMessageCard.appendChild(messageP);
            messagesContainer.prepend(newMessageCard);

            // Reset form
            guestNameInput.value = "";
            guestMessageInput.value = "";
          } catch (error) {
            console.error("Error sending wish:", error);
            const errMsg =
              error instanceof Error ? error.message : String(error);
            showToast(errMsg, "error");
          } finally {
            submitButton.disabled = false;
            submitButton.innerText = "Gửi Lời Chúc";
          }
        });
      }
    </script>
  </body>
</html>
